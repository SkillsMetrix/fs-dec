import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.apache.kafka.common.serialization.Serdes;
import org.apache.kafka.streams.*;
import org.apache.kafka.streams.kstream.*;

import java.util.Properties;

public class PaymentStreamsApp {
    private static final ObjectMapper mapper = new ObjectMapper();

    public static void main(String[] args) {
        Properties props = new Properties();
        props.put(StreamsConfig.APPLICATION_ID_CONFIG, "payments-app-minimal");
        props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        props.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass().getName());
        props.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass().getName());

        StreamsBuilder builder = new StreamsBuilder();

        // read raw JSON strings
        KStream<String, String> src = builder.stream("payments-input", Consumed.with(Serdes.String(), Serdes.String()));

        // key by method (UPI/CARD/CASH) â€” keep original JSON as value
        KStream<String, String> keyed = src.flatMap((k, v) -> {
            try {
                JsonNode n = mapper.readTree(v);
                String method = n.path("method").asText("").toUpperCase();
                if (method.isEmpty()) return java.util.List.<KeyValue<String,String>>of();
                return java.util.List.of(KeyValue.pair(method, v));
            } catch (Exception e) {
                return java.util.List.of();
            }
        });

        // aggregate into a simple JSON string using String Serde (count + totalAmount)
        KTable<String, String> agg = keyed
            .groupByKey(Grouped.with(Serdes.String(), Serdes.String()))
            .aggregate(
                () -> "{\"count\":0,\"totalAmount\":0.0}", // initializer (JSON string)
                (method, newVal, aggVal) -> {
                    try {
                        JsonNode incoming = mapper.readTree(newVal);
                        JsonNode current = mapper.readTree(aggVal);
                        long count = current.path("count").asLong();
                        double total = current.path("totalAmount").asDouble();

                        count += 1;
                        double amount = incoming.path("amount").asDouble(0.0);
                        total += amount;

                        return mapper.createObjectNode()
                                .put("count", count)
                                .put("totalAmount", total)
                                .toString();
                    } catch (Exception ex) {
                        return aggVal; // on error keep previous
                    }
                },
                Materialized.with(Serdes.String(), Serdes.String())
            );

        // write aggregates as stringified JSON
        agg.toStream().to("payments-aggregates", Produced.with(Serdes.String(), Serdes.String()));

        KafkaStreams streams = new KafkaStreams(builder.build(), props);
        Runtime.getRuntime().addShutdownHook(new Thread(streams::close));
        System.out.println("Starting streams...");
        streams.start();
    }
}
